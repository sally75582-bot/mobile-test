<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Judgment Day — Frank Castle Protocol (Mobile Final)</title>
<style>
  :root {
    --bg: #050607;
    --fg: #e6e6e6;
    --muted: #9aa0a6;
    --red: #ff2b2b;
    --accent: #ff3b3b;
  }
  * { box-sizing: border-box; }
  html, body { margin: 0; padding: 0; height: 100%; }

  body {
    background: radial-gradient(1200px 800px at 50% -10%, #111 0%, var(--bg) 45%, #000 100%);
    color: var(--fg);
    font-family: ui-monospace, Menlo, Consolas, monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .frame {
    width: 95%;
    max-width: 800px;
    min-height: 90vh;
    background: #0a0c0d;
    border-radius: 18px;
    border: 1px solid #161a1d;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,.5);
  }

  header {
    padding: 14px 16px;
    border-bottom: 1px solid #121416;
    background: #0f1113;
    text-transform: uppercase;
    letter-spacing: .1em;
    font-size: 12px;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
  }
  header .badge { color: var(--accent); font-weight: bold; }

  .screen {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    font-size: clamp(13px, 2.5vw, 15px);
    line-height: 1.55;
    /* 🛠️ 추가: GIF 요소가 버튼 위에 겹쳐 터치 방해하지 않도록 z-index 확인 */
    position: relative;
    z-index: 1;
  }

  .choices {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 12px;
    /* 🛠️ 모바일 터치 확보를 위해 z-index 조정 */
    position: relative;
    z-index: 10; 
  }

  .btn {
    border: 1px solid var(--red);
    color: var(--fg);
    background: rgba(255, 20, 20, 0.05);
    padding: 14px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    font-size: 15px;
    text-align: center;
    transition: background 0.15s ease, transform 0.1s ease;
  }
  .btn:hover, .btn:focus { background: rgba(255, 20, 20, 0.12); }
  .btn:active { transform: scale(0.97); }
  .btn[disabled] { opacity: 0.6; pointer-events: none; }

  .footer {
    padding: 10px 14px;
    border-top: 1px solid #121416;
    font-size: 12px;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 6px;
  }

  .bar {
    height: 8px;
    border-radius: 999px;
    background: #121416;
    overflow: hidden;
    width: 40%;
  }
  .bar > span {
    display: block;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #4f0000, var(--red));
    transition: width 0.3s ease;
  }

  pre#output { white-space: pre-wrap; word-wrap: break-word; margin: 0; }
  
  /* 🛠️ 글리치 애니메이션 추가 */
  @keyframes glitch {
    0% { text-shadow: 1px 0 0 var(--red), -1px 0 0 var(--accent); transform: translate3d(0, 0, 0); }
    25% { text-shadow: 2px 0 0 var(--red), -2px 0 0 var(--accent); transform: translate3d(-1px, 0, 0); opacity: 0.9; }
    50% { text-shadow: 1px 0 0 var(--red), -1px 0 0 var(--accent); transform: translate3d(1px, 0, 0); }
    75% { text-shadow: -2px 0 0 var(--red), 2px 0 0 var(--accent); transform: translate3d(-1px, 0, 0); }
    100% { text-shadow: 1px 0 0 var(--red), -1px 0 0 var(--accent); transform: translate3d(0, 0, 0); opacity: 1; }
  }

  .glitch-text {
    animation: glitch 0.1s linear infinite alternate;
  }
</style>
</head>
<body>
<div class="frame">
  <header>
    <div>FRANK CASTLE <span class="badge">/ PROTOCOL</span></div>
    <div class="dim">MOBILE</div>
  </header>
  <div class="screen" id="screen">
    <pre id="output">[READY] Press BEGIN to enter.</pre>
    <img id="endingGif" src="" alt="Ending Visual" style="display:none; width:100%; max-width:600px; margin: 20px auto; border-radius: 8px;">
    <div class="choices" id="choices"></div>
  </div>
  <div class="footer">
    <div>STATUS: <span id="status" class="accent">IDLE</span></div>
    <div class="bar"><span id="progress"></span></div>
  </div>
</div>

<script>
window.onload = function(){
  const out = document.getElementById('output');
  const choicesEl = document.getElementById('choices');
  const statusEl = document.getElementById('status');
  const progressEl = document.getElementById('progress');

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function flush(){ return new Promise(r=>setTimeout(r,0)); }

  async function type(line='', delay=14){
    for(let i=0;i<line.length;i++){
      out.textContent += line[i];
      await flush();
      await sleep(delay);
    }
    out.textContent += '\n';
    out.scrollTop = out.scrollHeight;
    await flush();
  }

  function clearOutput(){ out.textContent=''; }
  function setStatus(t,cls='accent'){ statusEl.className=cls; statusEl.textContent=t; }
  function setProgress(p){ progressEl.style.width = Math.min(100, Math.max(0,p))+'%'; }

  function btn(label,cb){
    const b=document.createElement('button');
    b.className='btn';
    b.textContent=label;
    
    // 🛠️ 모바일 터치 이슈 해결을 위한 eventListener 기반 로직 (이전 수정안 적용)
    const handler = async (e) => {
        // e.preventDefault(); // 스크롤 방해 가능성 때문에 주석 처리
        b.removeEventListener('touchend', handler);
        b.removeEventListener('click', handler);
        b.disabled=true;
        await cb();
        // 다음 버튼이 생성될 때까지 비활성화 유지
    };
    
    b.addEventListener('touchend', handler);
    b.addEventListener('click', handler);
    
    return b;
  }

  const intro = [
    '[ACCESSING SYSTEM...]',
    'FRANK CASTLE_JUDGMENT PROTOCOL',
    'You think you know justice?',
    "Let's find out."
  ];

  const qs = [
    {q:'Do you believe the law brings justice?', a:[
      {label:'Yes',s:0},{label:'No',s:1},{label:'Justice comes from power',s:2}]},
    {q:'Would you kill to protect your family?', a:[
      {label:'Never',s:0},{label:'If no other choice',s:1},{label:'Without hesitation',s:2}]},
    {q:'Are you a good person?', a:[
      {label:'Yes',s:0},{label:'Not sure',s:1},{label:'No',s:2}]}
  ];

  const verdicts={ low:'SPARED', mid:'GUILTY', high:'IRREDEEMABLE' };
  const state={i:0,score:0};

  async function begin(){
    clearOutput(); choicesEl.innerHTML='';
    await type('[BOOT SEQUENCE STARTED]');
    for(const l of intro) await type(l,20);
    next();
  }

  async function next(){
    if(state.i>=qs.length){return analyze();}
    const q=qs[state.i];
    await type(q.q,18);
    choicesEl.innerHTML='';
    // 엔딩 GIF가 있다면 숨김 처리
    document.getElementById('endingGif').style.display = 'none';
    q.a.forEach(opt=>{
      choicesEl.appendChild(btn(opt.label, async()=>{
        state.score+=opt.s;
        await type('> '+opt.label,10);
        state.i++;
        next();
      }));
    });
  }

  async function analyze(){
    choicesEl.innerHTML='';
    
    // 🛠️ 글리치 효과 적용
    out.classList.add('glitch-text');
    
    await type('[SYSTEM]: Analyzing responses...',12);
    for(let p=0;p<=100;p+=10){ setProgress(p); await sleep(100); }
    
    // 🛠️ 글리치 효과 해제
    out.classList.remove('glitch-text');
    
    let v = state.score<=1?verdicts.low:state.score<=3?verdicts.mid:verdicts.high;
    
    // 🛠️ 엔딩별 GIF URL 정의 및 적용
    const gifUrls = {
        'SPARED': '[여기에 SPARED 엔딩 GIF 웹 주소를 넣어주세요]', 
        'GUILTY': '[여기에 GUILTY 엔딩 GIF 웹 주소를 넣어주세요]', 
        'IRREDEEMABLE': 'https://64.media.tumblr.com/7a11aa83b3f0345816fe55182d8fd99b/d6ef2c795654f2c0-7c/s500x750/7c5727969a34822a3495bcd1576c4a8d786b6072.gif' // 요청하신 GIF
    };
    
    const gifEl = document.getElementById('endingGif');
    gifEl.src = gifUrls[v];
    gifEl.style.display = 'block'; // GIF 보이기
    
    await type('[CASTLE]: Verdict - '+v,14);
    choicesEl.appendChild(btn('Run Again',()=>location.reload()));
  }

  // 초기 화면 세팅
  setStatus('IDLE');
  const beginBtn = btn('BEGIN', begin);
  choicesEl.appendChild(beginBtn);
};
</script>
</body>
</html>
